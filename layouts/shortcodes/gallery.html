{{- $imagePath := .Get "imagePath" | default "submit" -}}
{{- $useExifCaption := .Get "useExifCaption" | default false -}}
{{- $useRandomImageStack := .Get "useRandomImageStack" | default false -}}
{{- $imageCssClass := .Get "imageCssClass" | default "lightbox size-medium" -}}
{{- $ratio := .Get "ratio" | default "auto" -}}
{{- $loading := .Get "loading" | default "lazy" -}}
{{- $searchclass := .Get "searchclass" | default "md" -}}
{{- $showGalleryImageCaption := .Get "showGalleryImageCaption" | default true -}}
{{- $showSearch := .Get "showSearch" | default false -}}
{{- $galleryCssClass := .Get "galleryCssClass" | default "normal-gallery" -}}
{{- $caption := .Get "caption" | default "" -}}

{{- $images := slice -}}

{{- warnf "Gallery shortcode called with imagePath: '%s'" $imagePath -}}

{{- if eq $imagePath "submit" }}
    {{- $useExifCaption := false -}}
    {{/* Check for both Resources (capital R) and resources (lowercase r) */}}
    {{- if isset .Page.Params "Resources" -}}
        {{- $images = .Page.Params.Resources -}}
    {{- else if isset .Page.Params "resources" -}}
        {{- $images = .Page.Params.resources -}}
    {{- end -}}
    {{- warnf "Gallery: Using submit mode, found %d resources on page" (len $images) -}}
{{- else }}
    {{- $cleanImagePath := $imagePath -}}
    
    {{- if hasPrefix $imagePath "/" -}}
        {{- $cleanImagePath = strings.TrimPrefix "/" $imagePath -}}
    {{- end -}}

    {{- if not (hasSuffix $cleanImagePath "/") -}}
        {{- $cleanImagePath = printf "%s/" $cleanImagePath -}}
    {{- end -}}

    {{- warnf "Gallery: Cleaned imagePath: '%s'" $cleanImagePath -}}

    {{- $images = resources.Match (printf "%s*" $cleanImagePath) -}}
    {{- $images = where $images "MediaType.MainType" "image" -}}

    {{- warnf "Gallery: Found %d images matching pattern '%s*'" (len $images) $cleanImagePath -}}

    {{- if eq (len $images) 0 -}}
        {{- warnf "Gallery: No images found for path '%s' (cleaned from '%s'). Available resources pattern would be: '%s*'" $cleanImagePath $imagePath $cleanImagePath -}}
    {{- end -}}
{{- end }}

{{- if $useRandomImageStack -}}
    {{- $images = shuffle $images -}}
    {{- $galleryCssClass = "collage-gallery" -}}
{{- end -}}

{{- if $showSearch -}}
    {{ partial "assets/gallery-search-input.html" (dict "searchclass" (printf "mt-4 mt-%s-0" $searchclass)) }}
{{- end -}}

<div class="gallery {{ $galleryCssClass }}">
    {{- range $index, $image := $images }}
        {{- $imageUrl := .RelPermalink -}}
        {{- $imageResource := . -}}
        {{- $description := "" -}}
        {{- $title := "" -}}
        {{- $randomClass := "" -}}
        {{- $isError := false -}}

        {{ if eq $imagePath "submit" }}
            {{- $cleanResourcePath := $image.src -}}
            {{- warnf "Gallery: Original src: '%s'" $cleanResourcePath -}}
            
            {{- /* Handle absolute paths by removing leading slash */ -}}
            {{- if hasPrefix $cleanResourcePath "/" -}}
                {{- $cleanResourcePath = strings.TrimPrefix "/" $cleanResourcePath -}}
            {{- end -}}
            
            {{- /* Try to get the resource with the cleaned path */ -}}
            {{ with resources.Get $cleanResourcePath }}
                {{- $imageResource = . -}}
                {{- $imageUrl = .RelPermalink -}}
                {{- $title = $image.title -}}
                {{- $description = $image.params.description -}}
                {{- $randomClass = $image.params.cssClass -}}
            {{ else }}
                {{- /* If not found, try prepending 'assets/' since images are in assets/img */ -}}
                {{- $assetsPath := printf "assets/%s" $cleanResourcePath -}}
                {{ with resources.Get $assetsPath }}
                    {{- $imageResource = . -}}
                    {{- $imageUrl = .RelPermalink -}}
                    {{- $title = $image.title -}}
                    {{- $description = $image.params.description -}}
                    {{- $randomClass = $image.params.cssClass -}}
                {{ else }}
                    {{- /* If still not found, try the original path as-is */ -}}
                    {{- $imageResource = resources.GetMatch $cleanResourcePath -}}
                    {{- if $imageResource -}}
                        {{- $imageUrl = $imageResource.RelPermalink -}}
                        {{- $title = $image.title -}}
                        {{- $description = $image.params.description -}}
                        {{- $randomClass = $image.params.cssClass -}}
                    {{ else }}
                        {{ $isError = true }}
                        {{ warnf "Cannot find image resource: \"%s\"" $cleanResourcePath }}
                    {{- end -}}
                {{ end }}
            {{ end }}
        {{ end }}
        
        {{- if $useRandomImageStack }}
            {{- $sizes := slice "size-small" "size-medium" "size-large" }}
            {{- $randomClass = index $sizes (mod $index 3) -}}
        {{- end }}

        {{- $dataAttributes := "" -}}
        {{- if ne $title "" -}}
            {{- $dataAttributes = printf "%s data-image-title=%q" $dataAttributes $title -}}
        {{- end -}}
        {{- $CaptionValue := $description -}}

        {{- $exifValue := "" -}}
        {{- if and $useExifCaption $imageResource }}
            {{- with $imageResource.Exif -}}
                {{- with .Tags.ImageDescription -}}
                    {{- $exifValue = . -}}
                    {{- if ne $exifValue "" -}}
                        {{- $CaptionValue = $exifValue -}}
                    {{- end -}}
                {{- end -}}

                {{- with .Tags.XPKeywords -}}
                    {{- $keywords := . -}}
                    {{- if ne $keywords "" -}}
                        {{- $dataAttributes = printf "%s data-image-tags=%q" $dataAttributes $keywords -}}
                    {{- end }}
                {{- end -}}

                {{- with .Tags.XPSubject -}}
                    {{- $subject := . -}}
                    {{- if ne $subject "" -}}
                        {{- $dataAttributes = printf "%s data-image-subject=%q" $dataAttributes $subject -}}
                    {{- end }}
                {{- end -}}

                {{- with .Tags.XPComment -}}
                    {{- $XPComment := . -}}
                    {{- if ne $XPComment "" -}}
                        {{- $dataAttributes = printf "%s data-image-description=%q" $dataAttributes $XPComment -}}
                    {{- end }}
                {{- end -}}
            {{- end -}}
        {{- end -}}

        {{- if ne $exifValue "" -}}
            {{- $dataAttributes = printf "%s data-image-title=%q" $dataAttributes $CaptionValue -}}
        {{- end -}}

        {{- $dataAttributes = printf "%s data-image-permalink=%q" $dataAttributes $imageUrl -}}
        {{- $dataAttributes = printf "%s data-show-image-caption=%t" $dataAttributes $showGalleryImageCaption -}}

        {{- if ne $description "" -}}
            {{- $dataAttributes = printf "%s data-image-description=%q" $dataAttributes $description -}}
        {{- end -}}
       
        {{ if ne $description "" }}
            {{- $title = printf "%s \\n %s" $title $description -}}
        {{ end }}

        {{ if not $isError }}
            <div id="{{ $imageUrl }}" class="gallery-item {{ $randomClass }}" {{ $dataAttributes | safeHTMLAttr }} aria-describedby="{{ $title }}">
                {{ partial "assets/image.html" (dict
                    "src" $imageUrl
                    "ratio" $ratio
                    "page" $.Page
                    "class" $imageCssClass
                    "loading" $loading
                    "title" $title 
                    "caption" $caption
                ) }}
            </div>
        {{ end }}
    {{- end }}
</div>